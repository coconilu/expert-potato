# Expert Potato E2E æµ‹è¯•æ–‡æ¡£

## ğŸ“š æ–‡æ¡£å¯¼èˆª

- **[å¿«é€Ÿå…¥é—¨æŒ‡å—](./E2E_QUICK_START.md)** - 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹E2Eæµ‹è¯•
- **[å®Œæ•´æµ‹è¯•æŒ‡å—](./TESTING_GUIDE.md)** - è¯¦ç»†çš„æµ‹è¯•æ¶æ„å’Œæœ€ä½³å®è·µ
- **[æµ‹è¯•ç¤ºä¾‹å’Œæ¨¡æ¿](./TEST_EXAMPLES.md)** - å„ç§æµ‹è¯•ç”¨ä¾‹çš„ç¤ºä¾‹ä»£ç 
- **[æœ¬æ–‡æ¡£](./README.md)** - å®Œæ•´çš„æµ‹è¯•æ–‡æ¡£å’Œå‚è€ƒ

## æ¦‚è¿°

æœ¬æµ‹è¯•å¥—ä»¶ä¸º Expert Potato åº”ç”¨æä¾›äº†å®Œæ•´çš„ç«¯åˆ°ç«¯ï¼ˆE2Eï¼‰æµ‹è¯•ï¼Œæ¶µç›–äº†æ ¸å¿ƒåŠŸèƒ½æµç¨‹ï¼š

1. **æ–‡ä»¶é€‰æ‹©** - æµ‹è¯•éŸ³é¢‘/è§†é¢‘æ–‡ä»¶çš„é€‰æ‹©å’Œæ‹–æ‹½åŠŸèƒ½
2. **æ¨¡å‹é€‰æ‹©** - æµ‹è¯• large-v3-turbo ç­‰æ¨¡å‹çš„é€‰æ‹©
3. **æ–‡æ¡ˆæå–** - æµ‹è¯•ä»éŸ³é¢‘ä¸­æå–æ–‡å­—çš„åŠŸèƒ½
4. **æ–‡æ¡ˆä¿®å¤** - æµ‹è¯•ä½¿ç”¨ API å¯†é’¥ä¿®å¤æ–‡æ¡ˆçš„åŠŸèƒ½

## æµ‹è¯•æ¶æ„

### æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ __init__.py                 # æµ‹è¯•æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ README.md                   # æµ‹è¯•æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ config.py                   # æµ‹è¯•é…ç½®
â”œâ”€â”€ base_test.py               # åŸºç¡€æµ‹è¯•ç±»
â”œâ”€â”€ run_tests.py               # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ test_components.py         # ç»„ä»¶å•å…ƒæµ‹è¯•
â”œâ”€â”€ test_e2e_core_flow.py     # æ ¸å¿ƒæµç¨‹E2Eæµ‹è¯•ï¼ˆunittestç‰ˆæœ¬ï¼‰
â”œâ”€â”€ test_e2e_pytest.py       # æ ¸å¿ƒæµç¨‹E2Eæµ‹è¯•ï¼ˆpytestç‰ˆæœ¬ï¼‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_helpers.py       # æµ‹è¯•è¾…åŠ©å·¥å…·
â”œâ”€â”€ data/                     # æµ‹è¯•æ•°æ®ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â””â”€â”€ output/                   # æµ‹è¯•è¾“å‡ºç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
```

### æ ¸å¿ƒç»„ä»¶

#### 1. æµ‹è¯•é…ç½® (`config.py`)
- å®šä¹‰æµ‹è¯•ç›¸å…³çš„å¸¸é‡å’Œè·¯å¾„
- é…ç½®è¶…æ—¶æ—¶é—´å’Œç­‰å¾…æ—¶é—´
- ç®¡ç†æµ‹è¯•æ–‡ä»¶å’Œè¾“å‡ºç›®å½•

#### 2. æµ‹è¯•è¾…åŠ©å·¥å…· (`utils/test_helpers.py`)
- `UITestHelper`: UIè‡ªåŠ¨åŒ–æµ‹è¯•è¾…åŠ©ç±»
- `FileTestHelper`: æ–‡ä»¶æ“ä½œæµ‹è¯•è¾…åŠ©ç±»
- `MockAPIHelper`: æ¨¡æ‹ŸAPIæµ‹è¯•è¾…åŠ©ç±»

#### 3. åŸºç¡€æµ‹è¯•ç±» (`base_test.py`)
- æä¾›æµ‹è¯•çš„åŸºç¡€è®¾æ–½
- ç®¡ç†QApplicationç”Ÿå‘½å‘¨æœŸ
- æä¾›é€šç”¨çš„æµ‹è¯•æ–¹æ³•

## è¿è¡Œæµ‹è¯•

### ç¯å¢ƒå‡†å¤‡

1. å®‰è£…æµ‹è¯•ä¾èµ–ï¼š
```bash
uv add --group test pytest pytest-qt pytest-mock pytest-cov pytest-xvfb
```

2. ç¡®ä¿åº”ç”¨ä¾èµ–å·²å®‰è£…ï¼š
```bash
uv sync
```

### è¿è¡Œæ–¹å¼

#### æ–¹å¼1ï¼šä½¿ç”¨è‡ªå®šä¹‰æµ‹è¯•è¿è¡Œå™¨

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run python tests/run_tests.py

# åªè¿è¡ŒE2Eæµ‹è¯•
uv run python tests/run_tests.py e2e

# åªè¿è¡Œç»„ä»¶æµ‹è¯•
uv run python tests/run_tests.py component
```

#### æ–¹å¼2ï¼šä½¿ç”¨unittest

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run python -m unittest discover tests

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
uv run python -m unittest tests.test_e2e_core_flow
uv run python -m unittest tests.test_components

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
uv run python -m unittest tests.test_e2e_core_flow.TestCoreFlowE2E.test_complete_workflow
```

#### æ–¹å¼3ï¼šä½¿ç”¨pytest

```bash
# è¿è¡Œæ‰€æœ‰pytestæµ‹è¯•
uv run pytest tests/test_e2e_pytest.py -v

# è¿è¡Œç‰¹å®šæ ‡è®°çš„æµ‹è¯•
uv run pytest tests/test_e2e_pytest.py -m "e2e" -v
uv run pytest tests/test_e2e_pytest.py -m "api" -v
uv run pytest tests/test_e2e_pytest.py -m "slow" -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
uv run pytest tests/test_e2e_pytest.py::TestE2EWorkflow::test_complete_workflow -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
uv run pytest tests/test_e2e_pytest.py --cov=src --cov-report=html
```

## æµ‹è¯•ç”¨ä¾‹è¯´æ˜

### æ ¸å¿ƒæµç¨‹æµ‹è¯•

#### `test_complete_workflow`
å®Œæ•´çš„ç«¯åˆ°ç«¯å·¥ä½œæµç¨‹æµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
1. æ–‡ä»¶é€‰æ‹©å’ŒéªŒè¯
2. é¡µé¢å¯¼èˆª
3. æ–‡æ¡ˆæå–æ¨¡æ‹Ÿ
4. APIå¯†é’¥è¾“å…¥
5. æ–‡æ¡ˆä¿®å¤æ¨¡æ‹Ÿ

#### `test_file_selection_only`
ä¸“é—¨æµ‹è¯•æ–‡ä»¶é€‰æ‹©åŠŸèƒ½ï¼š
- æ–‡ä»¶æ‹–æ‹½æ¨¡æ‹Ÿ
- æ–‡ä»¶è·¯å¾„éªŒè¯
- çŠ¶æ€æ›´æ–°æ£€æŸ¥

#### `test_model_selection`
æµ‹è¯•æ¨¡å‹é€‰æ‹©åŠŸèƒ½ï¼š
- æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º
- æ¨¡å‹åˆ‡æ¢
- é»˜è®¤æ¨¡å‹éªŒè¯

#### `test_api_key_validation`
æµ‹è¯•APIå¯†é’¥éªŒè¯ï¼š
- æœ‰æ•ˆå¯†é’¥æ ¼å¼æ£€æŸ¥
- æ— æ•ˆå¯†é’¥æ‹’ç»
- å¯†é’¥é•¿åº¦éªŒè¯

### ç»„ä»¶å•å…ƒæµ‹è¯•

#### `TestFileDropArea`
- ç»„ä»¶åˆ›å»ºå’Œåˆå§‹åŒ–
- æ‹–æ‹½åŠŸèƒ½å¯ç”¨æ£€æŸ¥
- æ–‡ä»¶é€‰æ‹©ä¿¡å·æµ‹è¯•
- æ–‡ä»¶æ¸…é™¤åŠŸèƒ½æµ‹è¯•

#### `TestRefineArea`
- ä¿®å¤åŒºåŸŸç»„ä»¶åˆ›å»º
- APIå¯†é’¥è¾“å…¥æµ‹è¯•
- ä¿®å¤æŒ‰é’®åŠŸèƒ½æµ‹è¯•

#### `TestTextRefineWorker`
- å·¥ä½œçº¿ç¨‹åˆ›å»º
- æ¨¡æ‹ŸAPIè¯·æ±‚
- é”™è¯¯å¤„ç†æµ‹è¯•

#### `TestStateManager`
- å•ä¾‹æ¨¡å¼éªŒè¯
- æ–‡ä»¶çŠ¶æ€ç®¡ç†
- çŠ¶æ€é‡ç½®åŠŸèƒ½

## æµ‹è¯•æ•°æ®ç®¡ç†

### æµ‹è¯•æ–‡ä»¶
- æµ‹è¯•éŸ³é¢‘æ–‡ä»¶ï¼š`tests/data/test_audio.wav`
- æµ‹è¯•æ–‡æœ¬æ–‡ä»¶ï¼š`tests/data/test_text.txt`
- è‡ªåŠ¨ä» `.cache/large-v3-turbo.txt` å¤åˆ¶çœŸå®å†…å®¹

### è¾“å‡ºæ–‡ä»¶
- æµ‹è¯•è¾“å‡ºç›®å½•ï¼š`tests/output/`
- è‡ªåŠ¨æ¸…ç†æœºåˆ¶

## æ¨¡æ‹Ÿå’ŒMock

### APIæ¨¡æ‹Ÿ
- ä½¿ç”¨ `MockAPIHelper` æ¨¡æ‹ŸAPIå“åº”
- æ¨¡æ‹Ÿæ–‡æ¡ˆä¿®å¤ç»“æœ
- æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚ï¼ˆä½¿ç”¨ `unittest.mock.patch`ï¼‰

### UIæ“ä½œæ¨¡æ‹Ÿ
- æ–‡ä»¶æ‹–æ‹½æ¨¡æ‹Ÿ
- æŒ‰é’®ç‚¹å‡»æ¨¡æ‹Ÿ
- æ–‡æœ¬è¾“å…¥æ¨¡æ‹Ÿ
- é¡µé¢å¯¼èˆªæ¨¡æ‹Ÿ

## é…ç½®é€‰é¡¹

### è¶…æ—¶è®¾ç½®
```python
DEFAULT_TIMEOUT = 30      # é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
LONG_TIMEOUT = 120        # é•¿æ—¶é—´æ“ä½œè¶…æ—¶ï¼ˆç§’ï¼‰
WINDOW_WAIT_TIME = 2      # çª—å£æ˜¾ç¤ºç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
OPERATION_WAIT_TIME = 1   # æ“ä½œé—´éš”ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
```

### æµ‹è¯•æ¨¡å‹
```python
TEST_MODEL_NAME = "large-v3-turbo"  # æµ‹è¯•ä½¿ç”¨çš„æ¨¡å‹åç§°
```

### æ¨¡æ‹ŸAPIé…ç½®
```python
MOCK_API_KEY = "test_api_key_12345"     # æ¨¡æ‹ŸAPIå¯†é’¥
MOCK_API_URL = "http://localhost:8080/mock/api"  # æ¨¡æ‹ŸAPIåœ°å€
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **çª—å£æœªæ˜¾ç¤º**
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–QApplicationå®ä¾‹è¿è¡Œ
   - ç¡®ä¿æµ‹è¯•ç¯å¢ƒæ”¯æŒGUIæ˜¾ç¤º
   - åœ¨Linuxä¸Šå¯èƒ½éœ€è¦å®‰è£… `pytest-xvfb`

2. **ç»„ä»¶æœªæ‰¾åˆ°**
   - æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£ç¡®åŠ è½½
   - ç¡®è®¤ç»„ä»¶ç±»å‹å’ŒæŸ¥æ‰¾æ–¹æ³•
   - å¢åŠ ç­‰å¾…æ—¶é—´

3. **æ–‡ä»¶æ“ä½œå¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶æƒé™
   - ç¡®è®¤æµ‹è¯•ç›®å½•å­˜åœ¨
   - æ£€æŸ¥ç£ç›˜ç©ºé—´

4. **APIæµ‹è¯•å¤±è´¥**
   - æ£€æŸ¥mocké…ç½®
   - ç¡®è®¤ç½‘ç»œæ¨¡æ‹Ÿè®¾ç½®
   - éªŒè¯APIå¯†é’¥æ ¼å¼

### è°ƒè¯•æŠ€å·§

1. **å¢åŠ æ—¥å¿—è¾“å‡º**
```python
print(f"å½“å‰é¡µé¢ç±»å‹: {type(current_page)}")
print(f"æ‰¾åˆ°çš„ç»„ä»¶: {component}")
```

2. **å¢åŠ ç­‰å¾…æ—¶é—´**
```python
self.wait_and_process_events(5)  # ç­‰å¾…5ç§’
```

3. **ä½¿ç”¨æ–­ç‚¹è°ƒè¯•**
```python
import pdb; pdb.set_trace()
```

4. **æˆªå›¾è°ƒè¯•**ï¼ˆpytest-qtæ”¯æŒï¼‰
```python
qtbot.screenshot(window, "debug_screenshot.png")
```

## æŒç»­é›†æˆ

### GitHub Actions ç¤ºä¾‹

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install uv
      uses: astral-sh/setup-uv@v1
    - name: Set up Python
      run: uv python install 3.11
    - name: Install dependencies
      run: |
        uv sync
        uv add --group test pytest pytest-qt pytest-xvfb
    - name: Run tests
      run: |
        xvfb-run -a uv run pytest tests/test_e2e_pytest.py -v
```

## æ‰©å±•æµ‹è¯•

### æ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹

1. åœ¨ç›¸åº”çš„æµ‹è¯•æ–‡ä»¶ä¸­æ·»åŠ æ–°çš„æµ‹è¯•æ–¹æ³•
2. ä½¿ç”¨é€‚å½“çš„æµ‹è¯•æ ‡è®°ï¼ˆ`@pytest.mark.e2e`ç­‰ï¼‰
3. éµå¾ªç°æœ‰çš„å‘½åçº¦å®š
4. æ·»åŠ é€‚å½“çš„æ–‡æ¡£å­—ç¬¦ä¸²

### æ·»åŠ æ–°çš„æµ‹è¯•è¾…åŠ©æ–¹æ³•

1. åœ¨ `utils/test_helpers.py` ä¸­æ·»åŠ æ–°çš„è¾…åŠ©æ–¹æ³•
2. ç¡®ä¿æ–¹æ³•å…·æœ‰è‰¯å¥½çš„é”™è¯¯å¤„ç†
3. æ·»åŠ ç±»å‹æç¤ºå’Œæ–‡æ¡£å­—ç¬¦ä¸²
4. åœ¨ `utils/__init__.py` ä¸­å¯¼å‡ºæ–°æ–¹æ³•

### æ€§èƒ½æµ‹è¯•

å¯ä»¥æ·»åŠ æ€§èƒ½ç›¸å…³çš„æµ‹è¯•ï¼š
```python
@pytest.mark.slow
def test_large_file_processing(self, qtbot, main_window):
    """æµ‹è¯•å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½"""
    # æµ‹è¯•é€»è¾‘
```

## æœ€ä½³å®è·µ

1. **æµ‹è¯•éš”ç¦»**ï¼šæ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€
2. **æ¸…ç†èµ„æº**ï¼šæµ‹è¯•ç»“æŸåæ¸…ç†åˆ›å»ºçš„æ–‡ä»¶å’Œèµ„æº
3. **æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–**ï¼šä½¿ç”¨mockæ¨¡æ‹ŸAPIè°ƒç”¨å’Œæ–‡ä»¶æ“ä½œ
4. **åˆç†çš„ç­‰å¾…æ—¶é—´**ï¼šç»™UIæ“ä½œè¶³å¤Ÿçš„æ—¶é—´å®Œæˆ
5. **è¯¦ç»†çš„æ–­è¨€æ¶ˆæ¯**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
6. **æµ‹è¯•æ–‡æ¡£**ï¼šä¸ºå¤æ‚çš„æµ‹è¯•ç”¨ä¾‹æ·»åŠ è¯¦ç»†è¯´æ˜

## è´¡çŒ®æŒ‡å—

1. æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼ŒåŒæ—¶æ·»åŠ ç›¸åº”çš„æµ‹è¯•
2. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†æäº¤ä»£ç 
3. éµå¾ªç°æœ‰çš„ä»£ç é£æ ¼å’Œå‘½åçº¦å®š
4. æ›´æ–°ç›¸å…³æ–‡æ¡£
5. è€ƒè™‘æµ‹è¯•çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§